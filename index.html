<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" data-app-id="ZfzYzSRKHAJrKlhZsrBh0w" src="https://assets.yammer.com/platform/yam.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/jashkenas/underscore/master/underscore.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/cometd/cometd/master/cometd-javascript/jquery/src/main/webapp/jquery/jquery-1.9.1.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/cometd/cometd/master/cometd-javascript/jquery/src/main/webapp/jquery/jquery.cometd.js"></script>
</head>
<body>

<span id="yammer-login"></span>
<span id="thread-play"></span>
<script>
  function thread_html(base64_string) {
    return "<audio controls='controls' autobuffer='autobuffer' autoplay='autoplay'><source src='data:audio/mp3;base64,"+base64_string+"' /></audio>";
  }

  yam.connect.loginButton('#yammer-login', function (resp) {
    if (resp.authResponse) {
      console.log(resp);
      document.getElementById('yammer-login').innerHTML = 'Welcome to Yammer!';
      yam.request({
        url: "https://www.yammer.com/api/v1/realtime",
        method: "GET",
        success: function(data) { 
          //console.log(data)
          yam.cometd.configure({
            url: data.realtimeURI,
            logLevel: 'warn'
          })
          yam.cometd.handshake({ext: { token: data.authentication_token }});
        }
        });


      yam.request({
        url: "https://www.yammer.com/api/v1/messages/in_group/2243128.json",
        method: "GET",
        success: function (feed) {
          var channel_id = feed.meta.realtime.channel_id
          var collector = {}
          var totals = {}
          yam.cometd.subscribe('/feeds/' + channel_id + '/primary', function(rtdata) {
//if inreplyto save it 
//otherwise save it somewhere else

            console.log(rtdata);
            //console.log(collector,totals);
            var thread_id = rtdata.data.data.messages[0].thread_id;
            if(rtdata.data.data.messages[0].replied_to_id === null) {
              totals[thread_id] = parseInt(rtdata.data.data.messages[0].body.plain)
             } else {
              var msg = {
                thread_id: rtdata.data.data.messages[0].thread_id,
                message_id: rtdata.data.data.messages[0].id,
                plain_body: rtdata.data.data.messages[0].body.plain
                }
              if(typeof collector[thread_id] === 'undefined') { collector[thread_id] = [] }
              collector[thread_id].push(msg)
            }

            if(totals[thread_id] === collector[thread_id].length) {
              var string = "";
              var sorted_msgs = _(collector[thread_id]).sortBy(function(msg) {
                return msg.message_id
              })
              console.log(sorted_msgs)
              sorted_msgs.map(function(msg) { 
                string += msg.plain_body;
              })
              document.getElementById('thread-play').innerHTML = thread_html(string);
            }
          })
        },
        error: function (thread) {
          alert("There was an error with the request.");
        }
      });
    }
  });

  function collectData(data, collector) { 

  }

  function play_sound(thread_id) {
      yam.request({
        url: "https://www.yammer.com/api/v1/messages/in_thread/" + thread_id + ".json",
        method: "GET",
        success: function (thread) {
          messages = _(thread.messages).sortBy(function(message) {
            return message.id;
          });

          var string = "";
          messages.map(function(message) {
            if(message.body.plain !== "END") { string += message.body.plain; }
          })
          //console.log(string);

          document.getElementById('thread-play').innerHTML = thread_html(string);
          // console.log(thread);
        },
        error: function (thread) {
          alert("There was an error with the request.");
        }
      });
}
</script>
</body>
</html>
